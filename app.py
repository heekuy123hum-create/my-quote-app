import streamlit as st
import pandas as pd
from datetime import datetime
import os
from fpdf import FPDF

# ==========================================
# 1. INITIAL CONFIGURATION
# ==========================================
st.set_page_config(page_title="SIWAKIT Quotation System (Full)", layout="wide")

# ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Database (‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô Tab 2 ‡πÅ‡∏•‡∏∞ 3)
try:
    from st_supabase_connection import SupabaseConnection
    if os.environ.get("SUPABASE_URL"):
        conn = st.connection("supabase", type=SupabaseConnection)
    else:
        conn = None
except Exception:
    conn = None

def to_num(val):
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏á‡∏¥‡∏ô"""
    try:
        if isinstance(val, str): val = val.replace(',', '')
        return float(val) if val else 0.0
    except: return 0.0

# ==========================================
# 2. PDF GENERATION ENGINE
# ==========================================
def create_pdf(d, items_df, summary, sigs, remark_text):
    # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© A4
    pdf = FPDF(unit='mm', format='A4')
    pdf.set_margins(10, 10, 10)
    pdf.set_auto_page_break(auto=False)
    pdf.add_page()
    
    # ‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    font_path = "THSarabunNew.ttf"
    use_f = 'THSarabun' if os.path.exists(font_path) else 'Arial'
    if use_f == 'THSarabun':
        pdf.add_font('THSarabun', '', font_path)
        pdf.add_font('THSarabun', 'B', font_path)

    # --- HEADER SECTION ---
    # ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
    for ext in ['png', 'jpg', 'jpeg']:
        if os.path.exists(f"logo.{ext}"):
            pdf.image(f"logo.{ext}", x=10, y=10, w=22)
            break
            
    # ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏£‡∏≤
    pdf.set_xy(35, 10)
    pdf.set_font(use_f, 'B', 14)
    pdf.multi_cell(100, 6, f"‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: {d['my_comp']}\n‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: {d['my_addr']}\n‡πÇ‡∏ó‡∏£: {d['my_tel']} ‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£: {d['my_fax']}\n‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: {d['my_tax']}", 0, 'L')

    # ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
    pdf.set_xy(145, 10)
    pdf.set_font(use_f, 'B', 12)
    pdf.cell(55, 16, "", 1, 0)
    pdf.set_xy(146, 12)
    pdf.multi_cell(53, 6, f"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: {d['doc_no']}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {d['doc_date']}", 0, 'L')

    # ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
    pdf.set_y(42)
    pdf.set_font(use_f, 'B', 24)
    pdf.cell(0, 10, "‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (QUOTATION)", 0, 1, 'C')

    # --- CUSTOMER & CONDITIONS SECTION ---
    pdf.set_font(use_f, '', 14)
    pdf.ln(2)
    start_y = pdf.get_y()
    
    # [‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢] ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    pdf.set_xy(10, start_y)
    pdf.multi_cell(115, 6, f"‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: {d['contact']}\n‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: {d['c_name']}\n‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: {d['c_addr']}\n‡πÇ‡∏ó‡∏£: {d['c_tel']}  ‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£: {d['c_fax']}")
    y_left = pdf.get_y()
    
    # [‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤] ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    pdf.set_xy(130, start_y)
    pdf.multi_cell(75, 6, f"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: {d['due_date']}\n‡∏¢‡∏∑‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ß‡∏±‡∏ô): {d['valid_days']}  Expire Date: {d['exp_date']}\n‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (‡∏ß‡∏±‡∏ô): {d['credit']}", 0, 'L')
    y_right = pdf.get_y()
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    table_start_y = max(y_left, y_right) + 5
    pdf.set_y(table_start_y)

    # --- TABLE SECTION ---
    pdf.set_fill_color(240, 240, 240)
    pdf.set_font(use_f, 'B', 11)
    w = [15, 75, 15, 15, 25, 15, 30]
    headers = ["‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏´‡∏ô‡πà‡∏ß‡∏¢", "‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢", "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"]
    for i in range(len(headers)):
        pdf.cell(w[i], 8, headers[i], 1, 0, 'C', True)
    pdf.ln()

    # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏õ‡∏£‡∏±‡∏ö Row Height ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 6.0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô‡∏°‡∏≤)
    pdf.set_font(use_f, '', 11)
    row_height = 6.0  # ‡∏•‡∏î‡∏à‡∏≤‡∏Å 6.5 -> 6.0 (20 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ 10mm)
    for i in range(20):
        if i < len(items_df):
            row = items_df.iloc[i]
            if str(row.get('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','')).strip() != "":
                val = [
                    str(row.get('‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','')), 
                    str(row.get('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','')), 
                    f"{to_num(row.get('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô')):,.0f}", 
                    str(row.get('‡∏´‡∏ô‡πà‡∏ß‡∏¢','')), 
                    f"{to_num(row.get('‡∏£‡∏≤‡∏Ñ‡∏≤')):,.0f}", 
                    f"{to_num(row.get('‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î')):,.0f}", 
                    f"{to_num(row.get('‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô',0)):,.0f}"
                ]
            else: val = [""]*7
        else: val = [""]*7
        
        for j in range(7):
            align = 'L' if j == 1 else 'C'
            if j == 6: align = 'R'
            pdf.cell(w[j], row_height, val[j], 1, 0, align)
        pdf.ln()

    # --- FOOTER & FINANCIAL SUMMARY SECTION ---
    # *‡∏à‡∏∏‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç*: ‡∏Ç‡∏¢‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏ß‡πâ‡∏ô‡πÅ‡∏Ñ‡πà 2mm)
    current_y_after_table = pdf.get_y()
    pdf.set_y(current_y_after_table + 2) 
    
    sum_y = pdf.get_y()
    
    # 1. ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢)
    pdf.set_xy(10, sum_y)
    pdf.set_font(use_f, 'B', 12)
    pdf.cell(20, 6, "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:", 0, 1, 'L')
    pdf.set_font(use_f, '', 12)
    pdf.set_x(10)
    pdf.multi_cell(105, 5, remark_text, 0, 'L')
    
    # 2. ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤)
    labels_x = 125 
    values_x = 175 
    sum_line_h = 5.0 # ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö

    def add_sum_row(label, value, is_bold=False, is_red=False):
        pdf.set_font(use_f, 'B' if is_bold else '', 13 if is_bold else 12)
        if is_red: pdf.set_text_color(180, 0, 0)
        else: pdf.set_text_color(0, 0, 0)
        
        # ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏à‡∏≥‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Y ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô‡∏™‡∏ô‡∏¥‡∏ó
        curr_y = pdf.get_y()
        pdf.set_xy(labels_x, curr_y)
        pdf.cell(45, sum_line_h, label, 0, 0, 'R')
        pdf.set_xy(values_x, curr_y)
        pdf.cell(25, sum_line_h, f"{value:,.2f}", 'B', 1, 'R')

    # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
    add_sum_row("‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (Gross Total):", summary['gross'])
    add_sum_row("‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (Total Discount):", summary['discount'])
    add_sum_row("‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (Sub Total):", summary['subtotal'])
    add_sum_row("‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° (VAT 7%):", summary['vat'])
    add_sum_row("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô (Grand Total):", summary['grand_total'], True, True)

    # 3. ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô (‡∏•‡πá‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    # ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
    pdf.set_y(-35)
    pdf.set_text_color(0, 0, 0)
    pdf.set_font(use_f, '', 11)
    titles = ["‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡∏∑‡πâ‡∏≠ (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)", "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢", "‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢"]
    names = [sigs['s1'], sigs['s2'], sigs['s3']]
    pos_x = [10, 75, 140]
    
    y_sig = pdf.get_y()
    for i in range(3):
        pdf.set_xy(pos_x[i], y_sig)
        pdf.cell(60, 5, "...................................................", 0, 1, 'C')
        pdf.set_xy(pos_x[i], y_sig + 5); pdf.cell(60, 5, titles[i], 0, 1, 'C')
        pdf.set_xy(pos_x[i], y_sig + 10); pdf.cell(60, 5, f"({names[i]})" if names[i] else "(...................................................)", 0, 1, 'C')
        pdf.set_xy(pos_x[i], y_sig + 15); pdf.cell(60, 5, "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ......../......../........", 0, 1, 'C')

    return bytes(pdf.output())

# ==========================================
# 3. USER INTERFACE SECTION
# ==========================================
st.title("üöÄ SIWAKIT Enterprise Quotation System")

tab1, tab2, tab3 = st.tabs(["üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤", "üë• ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", "üì¶ ‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"])

with tab1:
    # --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Header ---
    c1, c2 = st.columns(2)
    with c1:
        st.subheader("üè¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤")
        my_comp = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó", "SIWAKIT")
        my_addr = st.text_input("‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó")
        my_tel = st.text_input("‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", "02-xxx-xxxx")
        my_fax = st.text_input("‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£ (Fax)", "-")
        my_tax = st.text_input("‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ", "1234567890123")
    with c2:
        st.subheader("üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£")
        doc_no = st.text_input("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤", f"QT-{datetime.now().strftime('%y%m%d-%H')}")
        doc_date = st.text_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", datetime.now().strftime('%d/%m/%Y'))
        due_date = st.text_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á", "7 ‡∏ß‡∏±‡∏ô")
        
        col_v1, col_v2 = st.columns(2)
        valid_days = col_v1.text_input("‡∏¢‡∏∑‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ß‡∏±‡∏ô)", "30")
        exp_date = col_v2.text_input("Expire Date", datetime.now().strftime('%d/%m/%Y'))
        credit = st.text_input("‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡∏ß‡∏±‡∏ô)", "30")

    st.divider()

    # --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ---
    c3, c4 = st.columns(2)
    with c3:
        st.subheader("üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤")
        c_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤")
        contact = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠")
        c_addr = st.text_area("‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á/‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•", height=70)
    with c4:
        st.write("<br><br>", unsafe_allow_html=True)
        c_tel = st.text_input("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤")
        c_fax = st.text_input("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÅ‡∏ü‡∏Å‡∏ã‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤")

    # --- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
    st.subheader("üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    grid = st.data_editor(
        [{"‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": "", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": "", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": 0, "‡∏´‡∏ô‡πà‡∏ß‡∏¢": "", "‡∏£‡∏≤‡∏Ñ‡∏≤": 0, "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î": 0}] * 20, 
        num_rows="dynamic", use_container_width=True
    )
    
    # --- ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ---
    df = pd.DataFrame(grid)
    df['qty_n'] = df['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'].apply(to_num)
    df['pri_n'] = df['‡∏£‡∏≤‡∏Ñ‡∏≤'].apply(to_num)
    df['dis_n'] = df['‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î'].apply(to_num)
    df['‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô'] = (df['qty_n'] * df['pri_n']) - df['dis_n']
    
    gross_total = (df['qty_n'] * df['pri_n']).sum()
    total_discount = df['dis_n'].sum()
    subtotal = df['‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô'].sum()
    vat = subtotal * 0.07
    grand_total = subtotal + vat

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ---
    cf1, cf2 = st.columns([2, 1])
    with cf1:
        remark = st.text_area("üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Remark)", value="1. ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô 1 ‡∏õ‡∏µ\n2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏¢‡∏∑‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£")
    with cf2:
        st.write("### ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô")
        st.write(f"‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: {gross_total:,.2f}")
        st.write(f"‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: -{total_discount:,.2f}")
        st.write(f"‡∏¢‡∏≠‡∏î‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: {subtotal:,.2f}")
        st.write(f"‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° 7%: {vat:,.2f}")
        st.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô", f"{grand_total:,.2f} ‡∏ö‡∏≤‡∏ó")

    # --- ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô ---
    sc1, sc2, sc3 = st.columns(3)
    sig1 = sc1.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡∏∑‡πâ‡∏≠ (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)")
    sig2 = sc2.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢")
    sig3 = sc3.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢")

    # --- ‡∏õ‡∏∏‡πà‡∏° Generate ---
    if st.button("üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)", type="primary", use_container_width=True):
        doc_data = {
            "my_comp": my_comp, "my_addr": my_addr, "my_tel": my_tel, "my_fax": my_fax, "my_tax": my_tax,
            "doc_no": doc_no, "doc_date": doc_date, "due_date": due_date, "valid_days": valid_days, 
            "exp_date": exp_date, "credit": credit, "c_name": c_name, "contact": contact, 
            "c_addr": c_addr, "c_tel": c_tel, "c_fax": c_fax
        }
        
        pdf_res = create_pdf(
            doc_data, df, 
            {"gross": gross_total, "discount": total_discount, "subtotal": subtotal, "vat": vat, "grand_total": grand_total}, 
            {"s1": sig1, "s2": sig2, "s3": sig3}, 
            remark
        )
        
        st.success("‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
        st.download_button("üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤", pdf_res, f"{doc_no}.pdf", "application/pdf")

with tab2: st.info("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)")
with tab3: st.info("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)")
