import streamlit as st
import pandas as pd
from datetime import datetime
import os
from fpdf import FPDF
import json

# ==============================================================================
# 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (CONFIG & SESSION STATE)
# ==============================================================================
st.set_page_config(
    page_title="SIWAKIT TRADING SYSTEM", 
    layout="wide", 
    page_icon="üè¢"
)

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
CUST_FILE = "database_customers.csv"
PROD_FILE = "database_products.csv"
HISTORY_FILE = "history_quotes.csv"

# --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Reload Logic) ---
if "reload_command" in st.session_state:
    target_doc = st.session_state.reload_command
    
    if os.path.exists(HISTORY_FILE):
        try:
            df_hist = pd.read_csv(HISTORY_FILE, encoding='utf-8-sig')
            row = df_hist[df_hist['doc_no'] == target_doc]
            
            if not row.empty:
                # ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Dictionary
                saved_data = json.loads(row.iloc[0]['data_json'])
                
                # 1. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                st.session_state.grid_df = pd.DataFrame.from_dict(saved_data['grid_df'])
                
                # 2. ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Widget Mapping)
                keys_map = {
                    "doc_no_in": "doc_no",
                    "doc_date_in": "doc_date",
                    "due_date_in": "due_date",
                    "valid_days_in": "valid_days",
                    "credit_in": "credit",
                    "exp_date_in": "exp_date",
                    "c_name_in": "c_name",
                    "contact_in": "contact",
                    "c_addr_in": "c_addr", 
                    "c_tel_in": "c_tel",
                    "c_fax_in": "c_fax",
                    "remark_in": "remark", 
                    "has_vat_in": "has_vat",
                    "s1_in": "s1",
                    "s2_in": "s2",
                    "s3_in": "s3",
                    "my_comp_in": "my_comp",
                    "my_addr_in": "my_addr",
                    "my_tel_in": "my_tel", 
                    "my_fax_in": "my_fax",
                    "my_tax_in": "my_tax"
                }
                
                for key_ss, key_json in keys_map.items():
                    if key_json in saved_data:
                        st.session_state[key_ss] = saved_data[key_json]
                
                st.toast(f"‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• {target_doc} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!", icon="üîÑ")
        except Exception as e:
            st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {e}")
            
    # ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô
    del st.session_state.reload_command

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Session
if "grid_df" not in st.session_state:
    st.session_state.grid_df = pd.DataFrame(
        [
            {"‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": "", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": "", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": 0, "‡∏´‡∏ô‡πà‡∏ß‡∏¢": "", "‡∏£‡∏≤‡∏Ñ‡∏≤": 0.0, "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î": 0.0}
            for _ in range(20)
        ]
    )

# ==============================================================================
# 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (CORE FUNCTIONS)
# ==============================================================================

def load_databases():
    """‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏ö‡∏ö"""
    
    # --- ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ---
    if "db_customers" not in st.session_state:
        if os.path.exists(CUST_FILE):
            try:
                df = pd.read_csv(CUST_FILE, encoding='utf-8-sig')
                if 'Unnamed: 0' in df.columns:
                    df = df.drop(columns=['Unnamed: 0'])
                st.session_state.db_customers = df
            except:
                st.session_state.db_customers = pd.DataFrame(columns=["‡∏•‡∏ö", "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó", "‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠", "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà", "‡πÇ‡∏ó‡∏£", "‡πÅ‡∏ü‡∏Å‡∏ã‡πå"])
        else:
            st.session_state.db_customers = pd.DataFrame(columns=["‡∏•‡∏ö", "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó", "‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠", "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà", "‡πÇ‡∏ó‡∏£", "‡πÅ‡∏ü‡∏Å‡∏ã‡πå"])
        
        if '‡∏•‡∏ö' not in st.session_state.db_customers.columns:
            st.session_state.db_customers.insert(0, '‡∏•‡∏ö', False)

    # --- ‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
    if "db_products" not in st.session_state:
        if os.path.exists(PROD_FILE):
            try:
                df_p = pd.read_csv(PROD_FILE, encoding='utf-8-sig')
                if 'Unnamed: 0' in df_p.columns:
                    df_p = df_p.drop(columns=['Unnamed: 0'])
                if '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' in df_p.columns:
                    df_p['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'] = df_p['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'].astype(str)
                st.session_state.db_products = df_p
            except:
                st.session_state.db_products = pd.DataFrame(columns=["‡∏•‡∏ö", "‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏´‡∏ô‡πà‡∏ß‡∏¢"])
        else:
            st.session_state.db_products = pd.DataFrame(columns=["‡∏•‡∏ö", "‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏´‡∏ô‡πà‡∏ß‡∏¢"])
            
        if '‡∏•‡∏ö' not in st.session_state.db_products.columns:
            st.session_state.db_products.insert(0, '‡∏•‡∏ö', False)

    # --- ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ---
    if "db_history" not in st.session_state:
        if os.path.exists(HISTORY_FILE):
            try:
                st.session_state.db_history = pd.read_csv(HISTORY_FILE, encoding='utf-8-sig')
            except:
                st.session_state.db_history = pd.DataFrame(columns=["timestamp", "doc_no", "customer", "total", "data_json"])
        else:
            st.session_state.db_history = pd.DataFrame(columns=["timestamp", "doc_no", "customer", "total", "data_json"])

def save_csv(df, filename):
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å DataFrame ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå CSV"""
    temp = df.copy()
    if '‡∏•‡∏ö' in temp.columns:
        temp = temp.drop(columns=['‡∏•‡∏ö'])
    if 'Unnamed: 0' in temp.columns:
        temp = temp.drop(columns=['Unnamed: 0'])
    temp.to_csv(filename, index=False, encoding='utf-8-sig')

def to_num(val):
    """‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢"""
    try:
        if isinstance(val, str):
            val = val.replace(',', '')
        return float(val) if val else 0.0
    except:
        return 0.0

# ‡∏™‡∏±‡πà‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
load_databases()

# ==============================================================================
# 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF (PDF GENERATOR)
# ==============================================================================

def create_pdf(d, items_df, summary, sigs, remark_text, show_vat_line):
    pdf = FPDF(unit='mm', format='A4')
    pdf.set_margins(10, 10, 10)
    pdf.set_auto_page_break(auto=False)
    pdf.add_page()
    
    # ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    font_path = "THSarabunNew.ttf"
    if os.path.exists(font_path):
        pdf.add_font('THSarabun', '', font_path, uni=True)
        pdf.add_font('THSarabun', 'B', font_path, uni=True)
        use_f = 'THSarabun'
    else:
        use_f = 'Arial' 
    
    # ‡πÉ‡∏™‡πà Logo (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    for ext in ['png', 'jpg', 'jpeg']:
        if os.path.exists(f"logo.{ext}"):
            pdf.image(f"logo.{ext}", x=10, y=10, w=22)
            break

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏£‡∏≤ ---
    pdf.set_xy(35, 10)
    pdf.set_font(use_f, 'B', 14)
    header_text = (
        f"‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: {d['my_comp']}\n"
        f"‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: {d['my_addr']}\n"
        f"‡πÇ‡∏ó‡∏£: {d['my_tel']} ‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£: {d['my_fax']}\n"
        f"‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: {d['my_tax']}"
    )
    pdf.multi_cell(100, 6, header_text, 0, 'L')

    # --- ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ---
    pdf.set_xy(145, 10)
    pdf.set_font(use_f, 'B', 12)
    pdf.cell(55, 16, "", 1, 0) # ‡∏Å‡∏£‡∏≠‡∏ö
    pdf.set_xy(146, 12)
    pdf.multi_cell(53, 6, f"‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: {d['doc_no']}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: {d['doc_date']}", 0, 'L')

    # ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏´‡∏ç‡πà
    pdf.set_y(42)
    pdf.set_font(use_f, 'B', 24)
    pdf.cell(0, 10, "‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (QUOTATION)", 0, 1, 'C')

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ---
    pdf.set_font(use_f, '', 14)
    pdf.ln(2)
    start_info_y = pdf.get_y()
    
    # ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    pdf.set_xy(10, start_info_y)
    cust_info = (
        f"‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: {d['contact']}\n"
        f"‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: {d['c_name']}\n"
        f"‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: {d['c_addr']}\n"
        f"‡πÇ‡∏ó‡∏£: {d['c_tel']}  ‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£: {d['c_fax']}"
    )
    pdf.multi_cell(115, 6, cust_info, 0, 'L')
    y_left = pdf.get_y()
    
    # ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    pdf.set_xy(130, start_info_y)
    terms_info = (
        f"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: {d['due_date']}\n"
        f"‡∏¢‡∏∑‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ß‡∏±‡∏ô): {d['valid_days']}  Expire Date: {d['exp_date']}\n"
        f"‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (‡∏ß‡∏±‡∏ô): {d['credit']}"
    )
    pdf.multi_cell(75, 6, terms_info, 0, 'L')
    y_right = pdf.get_y()
    
    # ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Y ‡πÉ‡∏´‡πâ‡∏û‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô
    pdf.set_y(max(y_left, y_right) + 5)

    # --- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
    pdf.set_fill_color(240, 240, 240)
    pdf.set_font(use_f, 'B', 11)
    
    # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    w = [15, 75, 15, 15, 25, 15, 30]
    headers = ["‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏´‡∏ô‡πà‡∏ß‡∏¢", "‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢", "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"]
    
    for i in range(len(headers)):
        pdf.cell(w[i], 8, headers[i], 1, 0, 'C', True)
    pdf.ln()

    pdf.set_font(use_f, '', 11)
    row_height = 6.0
    
    # ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Fix ‡∏ó‡∏µ‡πà 20 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡∏π‡πÄ‡∏ï‡πá‡∏°)
    for i in range(20):
        if i < len(items_df):
            row = items_df.iloc[i]
            if str(row.get('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','')).strip() != "":
                vals = [
                    str(row.get('‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤','')),
                    str(row.get('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','')),
                    f"{to_num(row.get('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô')):,.0f}",
                    str(row.get('‡∏´‡∏ô‡πà‡∏ß‡∏¢','')),
                    f"{to_num(row.get('‡∏£‡∏≤‡∏Ñ‡∏≤')):,.0f}",
                    f"{to_num(row.get('‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î')):,.0f}",
                    f"{to_num(row.get('‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô',0)):,.0f}"
                ]
            else:
                vals = [""] * 7
        else:
            vals = [""] * 7
            
        for j in range(7):
            align = 'L' if j == 1 else 'C'
            if j == 6: align = 'R'
            pdf.cell(w[j], row_height, vals[j], 1, 0, align)
        pdf.ln()

    # --- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ---
    pdf.ln(2)
    footer_y = pdf.get_y()
    
    # ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
    pdf.set_xy(10, footer_y)
    pdf.set_font(use_f, 'B', 12)
    pdf.cell(20, 6, "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:", 0, 1, 'L')
    pdf.set_font(use_f, '', 12)
    pdf.set_x(10)
    pdf.multi_cell(105, 5, remark_text, 0, 'L')
    
    # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤
    curr_y = footer_y
    label_x, val_x = 125, 175

    def add_total_row(label, value, is_bold=False, is_red=False):
        nonlocal curr_y
        pdf.set_font(use_f, 'B' if is_bold else '', 13 if is_bold else 12)
        if is_red:
            pdf.set_text_color(180, 0, 0)
        else:
            pdf.set_text_color(0, 0, 0)
            
        pdf.set_xy(label_x, curr_y)
        pdf.cell(45, 5.5, label, 0, 0, 'R')
        pdf.set_xy(val_x, curr_y)
        pdf.cell(25, 5.5, f"{value:,.2f}", 'B', 1, 'R')
        curr_y += 5.5

    add_total_row("‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (Gross Total):", summary['gross'])
    add_total_row("‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (Total Discount):", summary['discount'])
    add_total_row("‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (Sub Total):", summary['subtotal'])
    if show_vat_line:
        add_total_row("‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° (VAT 7%):", summary['vat'])
    add_total_row("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô (Grand Total):", summary['grand_total'], True, True)

    # --- ‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ (‡∏ó‡πâ‡∏≤‡∏¢‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©) ---
    pdf.set_y(-35)
    pdf.set_text_color(0, 0, 0)
    pdf.set_font(use_f, '', 11)
    
    sig_titles = ["‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ã‡∏∑‡πâ‡∏≠ (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)", "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢", "‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢"]
    sig_names = [sigs['s1'], sigs['s2'], sigs['s3']]
    sig_x = [10, 75, 140]
    sig_y = pdf.get_y()
    
    for i in range(3):
        pdf.set_xy(sig_x[i], sig_y)
        pdf.cell(60, 5, "...................................................", 0, 1, 'C')
        pdf.set_xy(sig_x[i], sig_y + 5)
        pdf.cell(60, 5, sig_titles[i], 0, 1, 'C')
        pdf.set_xy(sig_x[i], sig_y + 10)
        pdf.cell(60, 5, f"({sig_names[i]})" if sig_names[i] else "(...................................................)", 0, 1, 'C')
        pdf.set_xy(sig_x[i], sig_y + 15)
        pdf.cell(60, 5, "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ......../......../........", 0, 1, 'C')

    return bytes(pdf.output())

# ==============================================================================
# 4. ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• UI (TABS)
# ==============================================================================

tab1, tab2, tab3, tab4 = st.tabs([
    "üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤", 
    "üë• ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", 
    "üì¶ ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", 
    "üóÇÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤"
])

# ------------------------------------------------------------------------------
# TAB 1: ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Quotation)
# ------------------------------------------------------------------------------
with tab1:
    col_comp_info, col_doc_info = st.columns(2)
    
    with col_comp_info:
        st.subheader("üè¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤")
        my_comp = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó", "‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏®‡∏¥‡∏ß‡∏Å‡∏¥‡∏à ‡πÄ‡∏ó‡∏£‡∏î‡∏î‡∏¥‡πâ‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î", key="my_comp_in")
        my_addr = st.text_input("‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó", "", key="my_addr_in") 
        my_tel = st.text_input("‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå", "", key="my_tel_in")      
        my_fax = st.text_input("‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£", "", key="my_fax_in")        
        my_tax = st.text_input("‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ", "", key="my_tax_in")
    
    with col_doc_info:
        st.subheader("üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£")
        doc_no = st.text_input("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤", f"QT-{datetime.now().strftime('%Y%m%d')}-001", key="doc_no_in")
        
        # --- [SYSTEM LOGIC] ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ---
        is_duplicate = False
        if not st.session_state.db_history.empty:
            if doc_no in st.session_state.db_history['doc_no'].values:
                is_duplicate = True
                st.error(f"‚ö†Ô∏è ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ '{doc_no}' ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ã‡πâ‡∏≥")
        
        doc_date = st.text_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", datetime.now().strftime('%d/%m/%Y'), key="doc_date_in")
        due_date = st.text_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á", "7 ‡∏ß‡∏±‡∏ô", key="due_date_in")
        
        v_col_1, v_col_2 = st.columns(2)
        valid_days = v_col_1.text_input("‡∏¢‡∏∑‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ß‡∏±‡∏ô)", "30", key="valid_days_in")
        exp_date = v_col_2.text_input("Expire Date", datetime.now().strftime('%d/%m/%Y'), key="exp_date_in")
        credit = st.text_input("‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (‡∏ß‡∏±‡∏ô)", "30", key="credit_in")

    st.divider()

    # --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å DB ---
    def update_customer_fields():
        selected_name = st.session_state.cust_selector
        if selected_name and selected_name != "-- ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà / ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á --":
            found = st.session_state.db_customers[st.session_state.db_customers['‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó'] == selected_name]
            if not found.empty:
                r = found.iloc[0]
                st.session_state.c_name_in = str(r.get('‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó', ''))
                st.session_state.contact_in = str(r.get('‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠', ''))
                st.session_state.c_addr_in = str(r.get('‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà', ''))
                st.session_state.c_tel_in = str(r.get('‡πÇ‡∏ó‡∏£', ''))
                st.session_state.c_fax_in = str(r.get('‡πÅ‡∏ü‡∏Å‡∏ã‡πå', ''))

    st.subheader("üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤")
    current_customers = st.session_state.db_customers['‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó'].dropna().unique().tolist()
    c_list_options = ["-- ‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà / ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á --"] + [str(x) for x in current_customers if str(x).strip() != ""]
    
    st.selectbox("üì• ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤", c_list_options, key="cust_selector", on_change=update_customer_fields)

    col_c_1, col_c_2 = st.columns(2)
    with col_c_1:
        c_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", key="c_name_in")
        contact = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠", key="contact_in")
        c_addr = st.text_area("‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á/‡∏ß‡∏≤‡∏á‡∏ö‡∏¥‡∏•", height=70, key="c_addr_in")
    with col_c_2:
        st.write("<br><br>", unsafe_allow_html=True) 
        c_tel = st.text_input("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", key="c_tel_in")
        c_fax = st.text_input("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÅ‡∏ü‡∏Å‡∏ã‡πå‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", key="c_fax_in")

    # --- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Data Editor) ---
    st.subheader("üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    current_products_list = st.session_state.db_products['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'].dropna().unique().tolist()
    p_codes_options = [str(x) for x in current_products_list if str(x).strip() != ""]
    
    edited_df = st.data_editor(
        st.session_state.grid_df,
        column_config={
            "‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": st.column_config.SelectboxColumn("‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", options=p_codes_options, width="medium"),
            "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": st.column_config.TextColumn("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", width="large"),
            "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": st.column_config.NumberColumn("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", min_value=0, format="%.2f"),
            "‡∏£‡∏≤‡∏Ñ‡∏≤": st.column_config.NumberColumn("‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢", min_value=0, format="%.2f"),
            "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î": st.column_config.NumberColumn("‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î", format="%.2f")
        },
        column_order=("‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô", "‡∏´‡∏ô‡πà‡∏ß‡∏¢", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î"),
        num_rows="dynamic",
        use_container_width=True,
        hide_index=True,
        key="editor_main_grid"
    )

    # --- ‡∏£‡∏∞‡∏ö‡∏ö Auto-Fill ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ---
    needs_refresh_editor = False
    for idx, row in edited_df.iterrows():
        item_code = str(row['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'])
        if item_code and item_code in p_codes_options:
            found_prod_df = st.session_state.db_products[st.session_state.db_products['‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'].astype(str) == item_code]
            if not found_prod_df.empty:
                prod_data = found_prod_df.iloc[0]
                # ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÉ‡∏™‡πà
                if row['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] != prod_data['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] and (row['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] == "" or row['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] is None):
                    edited_df.at[idx, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] = prod_data['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']
                    edited_df.at[idx, '‡∏´‡∏ô‡πà‡∏ß‡∏¢'] = prod_data['‡∏´‡∏ô‡πà‡∏ß‡∏¢']
                    edited_df.at[idx, '‡∏£‡∏≤‡∏Ñ‡∏≤'] = prod_data['‡∏£‡∏≤‡∏Ñ‡∏≤']
                    needs_refresh_editor = True

    if needs_refresh_editor:
        st.session_state.grid_df = edited_df
        st.rerun()
    else:
        st.session_state.grid_df = edited_df

    # --- ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ---
    calc_df = edited_df.copy()
    calc_df['qty_num'] = calc_df['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'].apply(to_num)
    calc_df['price_num'] = calc_df['‡∏£‡∏≤‡∏Ñ‡∏≤'].apply(to_num)
    calc_df['disc_num'] = calc_df['‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î'].apply(to_num)
    calc_df['‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô'] = (calc_df['qty_num'] * calc_df['price_num']) - calc_df['disc_num']
    
    sum_gross_val = (calc_df['qty_num'] * calc_df['price_num']).sum()
    sum_discount_val = calc_df['disc_num'].sum()
    sum_subtotal_val = calc_df['‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô'].sum()

    col_foot_left, col_foot_right = st.columns([2, 1])
    
    with col_foot_left:
        remark_text_area = st.text_area(
            "üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", 
            value="1. ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô 1 ‡∏õ‡∏µ\n2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏¢‡∏∑‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£", 
            key="remark_in"
        )
        
    with col_foot_right:
        st.write("### ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô")
        has_vat_check = st.checkbox("‡∏Ñ‡∏¥‡∏î VAT 7%", value=True, key="has_vat_in")
        vat_amount = (sum_subtotal_val * 0.07) if has_vat_check else 0.0
        grand_total_val = sum_subtotal_val + vat_amount

        st.write(f"‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: {sum_gross_val:,.2f}")
        st.write(f"‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: -{sum_discount_val:,.2f}")
        st.write(f"‡∏¢‡∏≠‡∏î‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: {sum_subtotal_val:,.2f}")
        if has_vat_check:
            st.write(f"‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° 7%: {vat_amount:,.2f}")
        st.metric("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô", f"{grand_total_val:,.2f} ‡∏ö‡∏≤‡∏ó")

    # ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
    col_sig_1, col_sig_2, col_sig_3 = st.columns(3)
    sig_1 = col_sig_1.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)", key="s1_in")
    sig_2 = col_sig_2.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢", key="s2_in")
    sig_3 = col_sig_3.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£", key="s3_in")

    # --- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å ---
    if st.button("üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥", type="primary", use_container_width=True):
        if not c_name:
            st.error("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤")
        elif is_duplicate:
            st.error("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ã‡πâ‡∏≥! ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'")
        else:
            # ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History)
            history_record = {
                "timestamp": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                "doc_no": doc_no,
                "customer": c_name,
                "total": grand_total_val,
                "data_json": json.dumps({
                    "grid_df": edited_df.to_dict(),
                    "doc_date": doc_date, "due_date": due_date, "valid_days": valid_days, 
                    "credit": credit, "exp_date": exp_date,
                    "c_name": c_name, "contact": contact, "c_addr": c_addr, 
                    "c_tel": c_tel, "c_fax": c_fax,
                    "remark": remark_text_area, "has_vat": has_vat_check, 
                    "s1": sig_1, "s2": sig_2, "s3": sig_3,
                    "my_comp": my_comp, "my_addr": my_addr, "my_tel": my_tel, 
                    "my_fax": my_fax, "my_tax": my_tax
                }, ensure_ascii=False)
            }
            
            # ‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
            new_hist_df = pd.DataFrame([history_record])
            st.session_state.db_history = pd.concat([new_hist_df, st.session_state.db_history], ignore_index=True)
            save_csv(st.session_state.db_history, HISTORY_FILE)
            st.toast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", icon="üíæ")

            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDF
            pdf_data_dict = {
                "my_comp": my_comp, "my_addr": my_addr, "my_tel": my_tel, "my_fax": my_fax, "my_tax": my_tax,
                "doc_no": doc_no, "doc_date": doc_date, "due_date": due_date, "valid_days": valid_days,
                "exp_date": exp_date, "credit": credit, "c_name": c_name, "contact": contact,
                "c_addr": c_addr, "c_tel": c_tel, "c_fax": c_fax
            }
            
            pdf_summary = {
                "gross": sum_gross_val, "discount": sum_discount_val, 
                "subtotal": sum_subtotal_val, "vat": vat_amount, 
                "grand_total": grand_total_val
            }
            
            pdf_signatures = {"s1": sig_1, "s2": sig_2, "s3": sig_3}
            
            # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF
            result_pdf_bytes = create_pdf(
                pdf_data_dict, calc_df, pdf_summary, pdf_signatures, 
                remark_text_area, has_vat_check
            )
            
            st.success("‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
            st.download_button(
                label="üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (PDF)",
                data=result_pdf_bytes,
                file_name=f"{doc_no}.pdf",
                mime="application/pdf",
                use_container_width=True
            )

    if st.button("üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà", use_container_width=True):
        st.session_state.grid_df = pd.DataFrame(
            [{"‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤": "", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": "", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": 0, "‡∏´‡∏ô‡πà‡∏ß‡∏¢": "", "‡∏£‡∏≤‡∏Ñ‡∏≤": 0.0, "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î": 0.0} for _ in range(20)]
        )
        keys_to_clear = [
            "doc_no_in", "c_name_in", "contact_in", "c_addr_in", 
            "c_tel_in", "c_fax_in", "cust_selector"
        ]
        for k in keys_to_clear:
            if k in st.session_state:
                del st.session_state[k]
        st.rerun()

# ------------------------------------------------------------------------------
# TAB 2: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Customer Database)
# ------------------------------------------------------------------------------
with tab2:
    st.header("üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤")
    st.info("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' | ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡πä‡∏Å‡∏ä‡πà‡∏≠‡∏á '‡∏•‡∏ö?' ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö")
    
    edited_cust_db = st.data_editor(
        st.session_state.db_customers, 
        num_rows="dynamic", 
        use_container_width=True, 
        hide_index=True,
        column_config={"‡∏•‡∏ö": st.column_config.CheckboxColumn("‡∏•‡∏ö?", default=False, width="small")},
        key="customer_table_editor"
    )
    
    col_c_btn1, col_c_btn2 = st.columns(2)
    with col_c_btn1:
        if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", type="primary", use_container_width=True):
            st.session_state.db_customers = edited_cust_db
            save_csv(edited_cust_db, CUST_FILE)
            st.toast("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß")
            st.rerun()
            
    with col_c_btn2:
        if st.button("‚ùå ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", use_container_width=True):
            remaining_cust = edited_cust_db[edited_cust_db['‡∏•‡∏ö'] == False]
            st.session_state.db_customers = remaining_cust
            save_csv(remaining_cust, CUST_FILE)
            st.toast("üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
            st.rerun()

# ------------------------------------------------------------------------------
# TAB 3: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Product Database)
# ------------------------------------------------------------------------------
with tab3:
    st.header("üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤")
    st.info("‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á")
    
    edited_prod_db = st.data_editor(
        st.session_state.db_products, 
        column_order=("‡∏•‡∏ö", "‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏´‡∏ô‡πà‡∏ß‡∏¢"),
        num_rows="dynamic", 
        use_container_width=True, 
        hide_index=True,
        column_config={"‡∏•‡∏ö": st.column_config.CheckboxColumn("‡∏•‡∏ö?", default=False, width="small")},
        key="product_table_editor"
    )
    
    col_p_btn1, col_p_btn2 = st.columns(2)
    with col_p_btn1:
        if st.button("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", type="primary", use_container_width=True):
            st.session_state.db_products = edited_prod_db
            save_csv(edited_prod_db, PROD_FILE)
            st.toast("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß")
            st.rerun()
            
    with col_p_btn2:
        if st.button("‚ùå ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", use_container_width=True):
            remaining_prod = edited_prod_db[edited_prod_db['‡∏•‡∏ö'] == False]
            st.session_state.db_products = remaining_prod
            save_csv(remaining_prod, PROD_FILE)
            st.toast("üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
            st.rerun()

# ------------------------------------------------------------------------------
# TAB 4: ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History Management)
# ------------------------------------------------------------------------------
with tab4:
    st.header("üóÇÔ∏è ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤")
    
    if not st.session_state.db_history.empty:
        # ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        all_doc_numbers = st.session_state.db_history["doc_no"].tolist()
        selected_to_reload = st.selectbox(
            "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:", 
            all_doc_numbers, 
            key="history_reloader"
        )
        
        if st.button("üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏à‡∏∞‡πÑ‡∏õ‡∏ó‡∏µ‡πà Tab 1)", use_container_width=True, type="primary"):
            st.session_state.reload_command = selected_to_reload
            st.rerun()
            
        st.divider()
        st.subheader("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î")
        
        # ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö
        edited_history_db = st.data_editor(
            st.session_state.db_history,
            column_config={
                "‡∏•‡∏ö": st.column_config.CheckboxColumn("‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥", default=False),
                "timestamp": st.column_config.TextColumn("‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤", disabled=True),
                "doc_no": st.column_config.TextColumn("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà", disabled=True),
                "customer": st.column_config.TextColumn("‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", disabled=True),
                "total": st.column_config.NumberColumn("‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°", format="%.2f", disabled=True),
                "data_json": None # ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö JSON
            },
            column_order=("‡∏•‡∏ö", "timestamp", "doc_no", "customer", "total"),
            use_container_width=True,
            hide_index=True,
            key="history_main_table"
        )
        
        if st.button("üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", use_container_width=True):
            remaining_history = edited_history_db[edited_history_db['‡∏•‡∏ö'] == False]
            st.session_state.db_history = remaining_history
            save_csv(remaining_history, HISTORY_FILE)
            st.toast("üóëÔ∏è ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß")
            st.rerun()
    else:
        st.info("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")
